---
description: Reglas del proyecto para el taller "IA para Toma de Decisiones en Triaje"
globs: ["**/*"]
alwaysApply: true
---

[REGLAS DEL PROYECTO â€” TALLER â€œIA para Toma de Decisiones en Triajeâ€]

Contexto

- Lenguaje de trabajo: EspaÃ±ol.
- Proyecto base ya configurado (React, Tailwind, Zod, @google/generative-ai, Router, RHF, Axios).
- La clave de Gemini estÃ¡ en `.env` como **API_GEMINI** (no versionado).
- VisualizaciÃ³n del flujo con **componentes simples** (sin React Flow).
- PolÃ­tica de ejecuciÃ³n: **NO hacer commits** durante el taller; al finalizar **cada paso**: ejecutar **`npm run build`** y corregir errores.

Alcance del taller

- ÃšNICA pÃ¡gina: **AgentStudioPage** con 5 zonas:
  1. **Cargar archivo** `.txt|.json`
  2. **Panel de Flujo** (badges conectados: Observe â†’ Think â†’ Plan â†’ Act â†’ Reflect/EO â†’ Guards â†’ Result)
  3. **Timeline** (pasos con notas y timestamps)
  4. **MÃ©tricas** (duraciÃ³n por nodo y total)
  5. **Visor JSON** (AGENT_OUTPUT v1 con Copiar/Descargar)
- Sin UI clÃ­nica. Input = archivo `.txt` con **AGENT_INPUT v1**. Salida = **AGENT_OUTPUT v1**.

Arquitectura mÃ­nima (directorios)

- `src/pages` â†’ `AgentStudioPage`
- `src/agent` â†’ `AgentController`, `ToolRegistry`, heurÃ­stica O-T-P-A-R
- `src/services` â†’ `InputSchema`, `PromptChaining`, `RetrievalService`, `Router`, `TriageService`, `AIClient/GeminiClient/Stub`, `Evaluator`, `Guards`, `OutputVerifier`, `Metrics`, `AuditLog`
- `src/ui` â†’ `FilePicker`, `PanelFlujoAgente`, `TimelineDecisiones`, `PanelMetricas`, `VisorJSON`, `BarraDemo`, `RouteBadge`, `Alerta`
- `src/data` â†’ **YA EXISTEN**: `protocols.json`, `vitals_reference.json`, y **ejemplos de pacientes** (ver mÃ¡s abajo)
- `src/styles` â†’ estilos globales

Contratos de datos

- **AGENT_INPUT v1**  
  `{ patient:{id,name,gender,age}, vitals:{systolic,diastolic,heartRate,respRate,temperature,spo2,painScore?}, symptoms:{text} }`
- **AGENT_OUTPUT v1**  
  `{ runId, startedAt, endedAt, input, route, decision:{triageClass,explanation,fuentes_usadas[]}, steps[], evaluator{threshold,iterations[]}, guards{inputIssues[],outputIssues[]}, metrics{totalMs,byNode[],iterationsEO,guardsTriggered}, auditLog[] }`

Principios del Agente

- **Uso condicional de herramientas**:
  - Caso **simple** â†’ atajo determinista (solo reglas; sin LLM, sin Evaluator).
  - Caso **medio** â†’ Retrieval + **Gemini** (clasificaciÃ³n).
  - Caso **complejo/alto riesgo** â†’ Retrieval + Gemini + **Evaluator** (segunda opiniÃ³n).
- **Evitar bucles**:
  - `maxIterations` (2â€“3), `confidenceThreshold` (~0.75), `timeout` por paso (6â€“8s).
  - BotÃ³n â€œCancelar ejecuciÃ³nâ€.
- **Anti-alucinaciÃ³n**:
  - Respuestas **estrictamente JSON** (sin texto extra).
  - **Citar fuentes** por `id` (subconjunto de `src/data/protocols.json`).
  - Si falta evidencia â†’ `requiere_mas_datos: true` y sugerir 1â€“2 datos concretos (no inventar).

UI (estructura conceptual)

- **Barra superior**: tÃ­tulo + botones (Cargar archivo, Reproducir flujo) + toggles (Presenter, Focus, Dark opcional).
- **Columna izquierda**: FilePicker (con issues visibles), RouteBadge, PanelMetricas.
- **Columna central**: PanelFlujoAgente con badges conectados (estado: pendiente/activo/ok/error).
- **Columna derecha**: TimelineDecisiones (pasos breves) + VisorJSON (AGENT_OUTPUT v1).

Reglas de ejecuciÃ³n de pasos (siempre visibles en UI)

- S1 Observe: al cargar y validar input â†’ **badge Observe = ok**, issues visibles (si existen).
- S2 Think: contexto + retrieval + chaining â†’ **badge Think = ok**, Timeline aÃ±ade 3â€“4 pasos.
- S3 Plan: ruta y selecciÃ³n de herramientas â†’ **badge Plan = ok**, RouteBadge visible.
- S4 Act: decisiÃ³n por reglas o Gemini â†’ **badge Act = ok**, JSON parcial con `decision`.
- S5 Reflect: EO si procede (lÃ­mite de iteraciones) â†’ **badge Reflect/EO = ok** o escalado.
- S6 Guards: verificaciÃ³n de salida + auditorÃ­a â†’ **badge Guards = ok** o **error** + Alerta.
- S7 Entrega: mÃ©tricas y JSON final + replay â†’ **badge Result = ok**.

PolÃ­tica de ejecuciÃ³n:

- **NO hacer commits** durante el taller.
- Al final de **cada paso**: ejecutar **`npm run build`** y corregir cualquier error antes de continuar.

```

---

## ðŸ“¦ Recordatorio de datos y ejemplos

- **Rutas**:
  - `./src/data/protocols.json`
  - `./src/data/vitals_reference.json`
  - `./src/data/examples/*.txt` (8 ejemplos: simples, medio, complejo, emergencias, faltantes, fuera de rango, JSON roto)
- Estos archivos normalizan resultados y reducen variabilidad entre corridas.

---

## ðŸ§© Plantillas GEMINI (config determinista)

> Config recomendada en el cliente:
> `{ temperature: 0, topK: 1, topP: 0.1, candidateCount: 1, maxOutputTokens: 512 }`
> Forzar `responseMimeType: "application/json"` si la SDK lo permite.

### A) ClasificaciÃ³n (Paso S4 â€” Act)
```

[ROL]
Asistente de triaje. No diagnosticas ni indicas tratamiento. Solo clasificar el caso segÃºn reglas y evidencia.
Si falta evidencia, devuelve "requiere_mas_datos": true. No inventes. Cita fuentes por sus IDs.

[ENTRADAS]

- Vitals (adulto): {{vitals_json}}
- SÃ­ntomas: {{symptoms_text_sanitized}}
- Ruta planificada: {{route}}
- Protocolos recuperados (idâ†’snippet): {{retrieval_pairs_json}}
- Reglas y umbrales: {{vitals_reference_json_min}}

[OBJETIVO â€” JSON ESTRICTO]
{
"triageClass": "consultorio" | "urgencias" | "emergencias",
"explanation": "string (<=240 chars, basada en evidencia)",
"fuentes_usadas": ["prot-id-1", "prot-id-2"],
"requiere_mas_datos": false
}

[REGLAS]

- Aplica primero "routing_rules".
- Solo en casos medio/comp, aÃ±ade razonamiento corto anclado a snippets.
- "fuentes_usadas" debe ser subconjunto de los IDs proporcionados en protocolos.
- Prohibido inventar sÃ­ntomas, valores o fuentes.
- Si falta evidencia, indica "requiere_mas_datos": true y sugiere 1â€“2 datos.
  [FORMATO] Responde EXCLUSIVAMENTE con JSON vÃ¡lido.

```

### B) EvaluaciÃ³n (Paso S5 â€” Reflect/EO)
```

[ROL]
Evaluador de calidad de decisiÃ³n de triaje. Verificas consistencia con reglas/umbrales y evidencia. No cambias el input.

[ENTRADAS]

- DecisiÃ³n actual: {{decision_json}}
- Contexto (vitals + sÃ­ntomas): {{context_json}}
- Reglas/umbrales: {{vitals_reference_json_min}}
- Evidencia (idâ†’snippet): {{retrieval_pairs_json}}

[OBJETIVO â€” JSON ESTRICTO]
{
"score": number (0..1),
"critiques": ["mÃ¡x 3 puntos concretos"],
"needsMoreInfo": boolean
}

[CRITERIOS]

- Penaliza si "fuentes_usadas" no justifican la clase propuesta.
- Penaliza si contradice "routing_rules".
- Marca datos faltantes cuando "needsMoreInfo": true.
  [FORMATO] Responde EXCLUSIVAMENTE con JSON vÃ¡lido.

```

```
